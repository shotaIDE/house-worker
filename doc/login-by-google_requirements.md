# Google アカウントでログイン機能の要件定義

## 概要

ユーザーが Google アカウントを使用してアプリケーションにログインできるようにする機能を実装します。これにより、ユーザーは匿名ログインだけでなく、Google アカウントを使用した認証も選択できるようになります。

## 背景と目的

- 現在のアプリケーションでは匿名認証のみがサポートされている
- Google アカウントでのログインを追加することで、以下のメリットが得られる：
  - ユーザーデータの永続化と複数デバイス間での同期
  - アカウント削除時のデータ保持
  - ユーザー体験の向上（毎回ログインする必要がない）
  - より信頼性の高いユーザー識別

## 機能要件

### 認証機能

- Google アカウントを使用したログイン機能の追加
- 既存の匿名認証機能の維持
- ログアウト機能の対応
- 匿名ユーザーから Google アカウントへの連携機能

### ユーザーインターフェース

- ログイン画面に「Google でログイン」ボタンを追加
- Google ログイン中のローディング表示
- ログイン成功/失敗時のフィードバック表示
- 設定画面での Google アカウント情報表示
- 匿名ユーザーに対して Google アカウント連携を促す機能

### データモデル

- `UserProfile`クラスの拡張
  - Google アカウント情報（表示名、メールアドレス、プロフィール画像 URL）の追加
- 認証状態の管理の拡張

### エラーハンドリング

- Google ログイン失敗時のエラーハンドリング
- ネットワーク接続エラーの処理
- アカウント連携失敗時のエラーハンドリング

## 非機能要件

### セキュリティ

- OAuth 2.0 プロトコルに準拠したセキュアな認証フロー
- ユーザー情報の安全な保存
- 適切なスコープ設定（必要最小限の権限要求）

### パフォーマンス

- ログインプロセスの高速化
- バックグラウンドでのトークン更新

### 互換性

- iOS/Android 両プラットフォームでの動作保証
- 異なる Google アカウントタイプ（個人、G Suite）との互換性

### プライバシー

- 収集するユーザー情報の明確化
- プライバシーポリシーの更新

## 技術要件

### 依存パッケージ

- `google_sign_in`パッケージの追加
- 既存の`firebase_auth`パッケージの活用

### Firebase 設定

- Firebase Console での設定
  - Google 認証プロバイダーの有効化
  - OAuth 同意画面の設定
- iOS/Android 向けの設定
  - iOS の Info.plist の更新
  - Android の buildGradle と AndroidManifest の更新

### コード変更

- `AuthService`クラスの拡張
  - Google ログイン機能の追加
  - 匿名アカウントと Google アカウントの連携機能
- `LoginScreen`の更新
  - Google ログインボタンの追加
  - ログイン状態の表示
- `SettingsScreen`の更新
  - Google アカウント情報の表示

## ユーザーフロー

### 新規ユーザーの Google ログイン

1. ユーザーがアプリを起動
2. ログイン画面で「Google でログイン」ボタンをタップ
3. Google アカウント選択画面が表示される
4. ユーザーがアカウントを選択
5. 認証成功後、ホーム画面に遷移

### 匿名ユーザーから Google アカウントへの連携

1. 匿名ユーザーが設定画面を開く
2. ユーザー情報セクションで「アカウント連携」オプションをタップ
3. 連携方法選択画面で Google を選択
4. Google アカウント選択画面が表示される
5. ユーザーがアカウントを選択
6. 連携成功後、更新されたユーザー情報が表示される

### ログアウト

1. ユーザーが設定画面を開く
2. 「ログアウト」ボタンをタップ
3. 確認ダイアログが表示される
4. ユーザーが確認すると、ログアウトしてログイン画面に戻る

## エッジケース

- ネットワーク接続がない場合のエラーハンドリング
- Google アカウント選択がキャンセルされた場合の処理
- 既に他の Google アカウントでログインしているユーザーが別のアカウントでログインを試みる場合
- 匿名ユーザーデータの Google アカウントへの移行処理
- アプリ内でのアカウント切り替え

## テスト要件

- 単体テスト
  - `AuthService`の各メソッドのテスト
  - ログイン状態管理のテスト
- 統合テスト
  - ログインフローのテスト
  - アカウント連携フローのテスト
- UI テスト
  - ログイン画面の表示テスト
  - エラー表示のテスト

## 制約事項

- Firebase Authentication の制限に準拠する必要がある
- Google の認証 API の利用制限を考慮する
- アプリのプライバシーポリシーを更新する必要がある

## 今後の拡張性

- 他のソーシャルログイン（Apple、Facebook、Twitter など）への対応
- 多要素認証の導入
- パスワードレスログインの検討
