# Google アカウントでのログイン機能要件定義

## 概要

現在のアプリでは匿名認証のみをサポートしていますが、ユーザーが Google アカウントを使用してログインできる機能を追加します。これにより、ユーザーは複数のデバイス間でデータを同期したり、アカウント情報を保持したりすることが可能になります。

## 機能要件

### 認証方法

- 既存の匿名認証に加えて、Google アカウントでのログイン機能を提供する
- ユーザーは初回ログイン時に匿名認証または Google アカウント認証を選択できる
- 既存の匿名ユーザーが Google アカウントに連携（アップグレード）できる機能を提供する

### ユーザーインターフェース

- ログイン画面に「Google でログイン」ボタンを追加する
  - ボタンは Google のブランドガイドラインに準拠したデザインとする
  - ボタンには適切なアイコンを表示する
- 匿名ユーザーがアプリ内で Google アカウントに連携できる導線を設定画面に追加する
- ログイン状態に応じて適切なユーザー情報を表示する
  - Google アカウントでログインしている場合は、ユーザー名とプロフィール画像を表示する
  - 匿名ユーザーの場合は、「ゲストユーザー」として表示する

### データ管理

- Google アカウントでログインした場合、ユーザーのプロフィール情報（名前、プロフィール画像 URL）を保存する
- 匿名ユーザーから Google アカウントへの連携時に、既存のデータ（家事記録など）を新しいアカウントに移行する
- 複数デバイスでのログイン時にデータの同期を保証する

### セキュリティ

- OAuth 2.0 プロトコルに基づいたセキュアな認証フローを実装する
- ユーザーの認証情報を安全に管理する
- アクセストークンの有効期限と更新メカニズムを適切に処理する

### エラーハンドリング

- ネットワーク接続の問題による認証失敗時の適切なエラーメッセージを表示する
- Google アカウント認証プロセスがキャンセルされた場合の適切な処理を行う
- アカウント連携時のエラー（既に別のアカウントに連携されている場合など）に対する適切な処理とメッセージを表示する

## 非機能要件

### パフォーマンス

- 認証プロセスは 3 秒以内に完了すること（ネットワーク状況に依存）
- 認証状態の変更はアプリ全体にリアルタイムで反映されること

### 互換性

- iOS、Android 両プラットフォームで Google ログインが正常に動作すること
- 異なるバージョンの OS でも互換性を保つこと

### ユーザビリティ

- ログインプロセスは直感的で、最小限のステップで完了できること
- エラーメッセージは明確で、ユーザーが次に取るべきアクションを示すこと
- アカウント連携のメリットをユーザーに明確に伝えること

### プライバシー

- 収集するユーザー情報を最小限に抑える（必要な情報のみ取得する）
- プライバシーポリシーを更新し、Google アカウント連携に関する情報を追加する
- ユーザーがアカウント連携を解除できる機能を提供する

## 技術要件

### フロントエンド

- Flutter 用の Firebase Authentication SDK を使用して Google ログイン機能を実装する
- `google_sign_in` パッケージを使用してプラットフォーム固有の認証フローを処理する
- 既存の `UserProfile` モデルを拡張して、Google アカウント情報を保持できるようにする
- `AuthService` クラスに新しいメソッド（`signInWithGoogle`、`linkWithGoogle` など）を追加する

### バックエンド

- Firebase Authentication 設定で Google プロバイダーを有効にする
- Terraform の `auth.tf` ファイルを更新して、Google プロバイダーの設定を追加する
- 必要に応じてセキュリティルールを更新し、認証されたユーザーのアクセス権を適切に設定する

### プラットフォーム固有の設定

- iOS: Google サービスの Info.plist ファイルを設定し、URL スキームを追加する
- Android: google-services.json ファイルを設定し、必要なパーミッションを追加する

## 制約事項

- ユーザーはインターネット接続がある状態でのみ Google ログインを使用できる
- オフライン状態では、前回ログインした認証情報を使用して制限付きの機能にアクセスできる
- 一つの Google アカウントは一つのアプリアカウントにのみ連携できる

## 将来の拡張性

- 他のソーシャルログイン（Apple、Facebook、Twitter など）への対応を容易にするための拡張性を考慮する
- メールアドレスとパスワードによる認証の追加も将来的に検討できるよう設計する
